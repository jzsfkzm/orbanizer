var config = {
  'Orbán Viktoréknak': [
    'Mészáros Lőrincéknek',
    'Tiborcz Istvánéknak',
    'Garancsi Istvánéknak',
    'Andy Vajnáéknak',
    'Flier Jánoséknak',
    'Orbán Ráheléknek'
  ],
  'Orbán Viktorékról': [
    'Mészáros Lőrincékről',
    'Tiborcz Istvánékról',
    'Garancsi Istvánékról',
    'Andy Vajnáékról',
    'Flier Jánosékról',
    'Orbán Ráhelékról'
  ],
  'Orbán Viktorékat': [
    'Mészáros Lőrincéket',
    'Tiborcz Istvánékat',
    'Garancsi Istvánékat',
    'Andy Vajnáékat',
    'Flier Jánosékat',
    'Orbán Ráheléket'
  ],
  'Orbán Viktorékhoz': [
    'Mészáros Lőrincékhez',
    'Tiborcz Istvánékhoz',
    'Garancsi Istvánékhoz',
    'Andy Vajnáékhoz',
    'Flier Jánosékhoz',
    'Orbán Ráhelékhoz'
  ],
  'Orbán Viktoréké': [
    'Mészáros Lőrincéké',
    'Tiborcz Istvánéké',
    'Garancsi Istvánéké',
    'Andy Vajnáéké',
    'Flier Jánoséké',
    'Orbán Ráheléké'
  ],
  'Orbán Viktoréktól': [
    'Mészáros Lőrincéktől',
    'Tiborcz Istvánéktól',
    'Garancsi Istvánéktól',
    'Andy Vajnáéktól',
    'Flier Jánoséktól',
    'Orbán Ráheléktól'
  ],
  'Orbán Viktorékkal': [
    'Mészáros Lőrincékkel',
    'Tiborcz Istvánékkal',
    'Garancsi Istvánékkal',
    'Andy Vajnáékkal',
    'Flier Jánosékkal',
    'Orbán Ráhelékkel'
  ],
  'Orbán Viktorékra': [
    'Mészáros Lőrincékre',
    'Tiborcz Istvánékra',
    'Garancsi Istvánékra',
    'Andy Vajnáékra',
    'Flier Jánosékra',
    'Orbán Ráhelékre'
  ],
  'Orbán Viktoréknál': [
    'Mészáros Lőrincéknél',
    'Tiborcz Istvánéknál',
    'Garancsi Istvánéknál',
    'Andy Vajnáéknál',
    'Flier Jánoséknál',
    'Orbán Ráheléknél'
  ],
  'Orbán Viktoréken': [
    'Mészáros Lőrincéken',
    'Tiborcz Istvánékon',
    'Garancsi Istvánékon',
    'Andy Vajnáékn',
    'Flier Jánosékon',
    'Orbán Ráheléken'
  ],
  'Orbán Viktorék': [
    'Mészáros Lőrincék',
    'Tiborcz Istvánék',
    'Garancsi Istvánék',
    'Andy Vajnaék',
    'Flier Jánosék',
    'Orbán Ráhelék'
  ],


  'Orbán Viktoroknak': [
    'Mészáros Lőrinceknek',
    'Tiborcz Istvánoknak',
    'Garancsi Istvánoknak',
    'Andy Vajnáknak',
    'Flier Jánosoknak',
    'Orbán Ráheleknek'
  ],
  'Orbán Viktorokról': [
    'Mészáros Lőrincekről',
    'Tiborcz Istvánokról',
    'Garancsi Istvánokról',
    'Andy Vajnákról',
    'Flier Jánosokról',
    'Orbán Ráhelekről'
  ],
  'Orbán Viktorokat': [
    'Mészáros Lőrinceket',
    'Tiborcz Istvánokat',
    'Garancsi Istvánokat',
    'Andy Vajnákat',
    'Flier Jánosokat',
    'Orbán Ráheleket'
  ],
  'Orbán Viktorokhoz': [
    'Mészáros Lőrincekhez',
    'Tiborcz Istvánokhoz',
    'Garancsi Istvánokhoz',
    'Andy Vajnákhoz',
    'Flier Jánosokhoz',
    'Orbán Ráhelekhez'
  ],
  'Orbán Viktoroké': [
    'Mészáros Lőrinceké',
    'Tiborcz Istvánoké',
    'Garancsi Istvánoké',
    'Andy Vajnáké',
    'Flier Jánosoké',
    'Orbán Ráheleké'
  ],
  'Orbán Viktoroktól': [
    'Mészáros Lőrincektől',
    'Tiborcz Istvánoktól',
    'Garancsi Istvánoktól',
    'Andy Vajnáktól',
    'Flier Jánosoktól',
    'Orbán Ráhelektől'
  ],
  'Orbán Viktorokkal': [
    'Mészáros Lőrincekkel',
    'Tiborcz Istvánokkal',
    'Garancsi Istvánokkal',
    'Andy Vajnákkal',
    'Flier Jánosokkal',
    'Orbán Ráhelekkel'
  ],
  'Orbán Viktorokra': [
    'Mészáros Lőrincekre',
    'Tiborcz Istvánokra',
    'Garancsi Istvánokra',
    'Andy Vajnákra',
    'Flier Jánosokra',
    'Orbán Ráhelekre'
  ],
  'Orbán Viktoroknál': [
    'Mészáros Lőrinceknél',
    'Tiborcz Istvánoknál',
    'Garancsi Istvánoknál',
    'Andy Vajnáknál',
    'Flier Jánosoknál',
    'Orbán Ráheleknél'
  ],
  'Orbán Viktorokon': [
    'Mészáros Lőrinceken',
    'Tiborcz Istvánokon',
    'Garancsi Istvánokon',
    'Andy Vajnákon',
    'Flier Jánosokon',
    'Orbán Ráheleken'
  ],
  'Orbán Viktorok': [
    'Mészáros Lőrincek',
    'Tiborcz Istvánok',
    'Garancsi Istvánok',
    'Andy Vajnák',
    'Flier Jánosok',
    'Orbán Ráheleken'
  ],


  'Orbán Viktornak': [
    'Mészáros Lőrincnek',
    'Tiborcz Istvánnak',
    'Garancsi Istvánnak',
    'Andy Vajnának',
    'Flier Jánosnak',
    'Orbán Ráhelnek'
  ],
  'Orbán Viktorról': [
    'Mészáros Lőrincről',
    'Tiborcz Istvánról',
    'Garancsi Istvánról',
    'Andy Vajnáról',
    'Flier Jánosról',
    'Orbán Ráhelről'
  ],
  'Orbán Viktort': [
    'Mészáros Lőrincet',
    'Tiborcz Istvánt',
    'Garancsi Istvánt',
    'Andy Vajnát',
    'Flier Jánost',
    'Orbán Ráhelt'
  ],
  'Orbán Viktorhoz': [
    'Mészáros Lőrinchez',
    'Tiborcz Istvánhoz',
    'Garancsi Istvánhoz',
    'Andy Vajnához',
    'Flier Jánoshoz',
    'Orbán Ráhelhez'
  ],
  'Orbán Viktoré': [
    'Mészáros Lőrincé',
    'Tiborcz Istváné',
    'Garancsi Istváné',
    'Andy Vajnáé',
    'Flier Jánosé',
    'Orbán Ráhelé'
  ],
  'Orbán Viktortól': [
    'Mészáros Lőrinctől',
    'Tiborcz Istvántól',
    'Garancsi Istvántól',
    'Andy Vajnától',
    'Flier Jánostól',
    'Orbán Ráheltől'
  ],
  'Orbán Viktorral': [
    'Mészáros Lőrinccel',
    'Tiborcz Istvánnal',
    'Garancsi Istvánnal',
    'Andy Vajnával',
    'Flier Jánossal',
    'Orbán Ráhellel'
  ],
  'Orbán Viktorra': [
    'Mészáros Lőrincre',
    'Tiborcz Istvánra',
    'Garancsi Istvánra',
    'Andy Vajnára',
    'Flier Jánosra',
    'Orbán Ráhelre'
  ],
  'Orbán Viktornál': [
    'Mészáros Lőrincnél',
    'Tiborcz Istvánnál',
    'Garancsi Istvánnál',
    'Andy Vajnánál',
    'Flier Jánosnál',
    'Orbán Ráhelnél'
  ],
  'Orbán Viktoron': [
    'Mészáros Lőrincen',
    'Tiborcz Istvánon',
    'Garancsi Istvánon',
    'Andy Vajnán',
    'Flier Jánoson',
    'Orbán Ráhelen'
  ],
  'Orbán Viktor': [
    'Mészáros Lőrinc',
    'Tiborcz István',
    'Garancsi István',
    'Andy Vajna',
    'Flier János',
    'Orbán Ráhel'
  ]
};

var elements = document.getElementsByTagName('*');

var textNodes = Array.from(elements).reduce(function(memo, element) {
  return memo.concat(Array.from(element.childNodes).filter(function(node) {
    return node.nodeType === 3;
  }));
}, []);

var textContent = textNodes.map(function(node) {
  return node.nodeValue;
}).join(' ');

var searchPhrases = Object.keys(config).reduce(function(memo, key) {
  return memo.concat(config[key]);
}, []);

var config = Object.keys(config).reduce(function(memo, key) {
  var found = config[key].filter(function(searchPhrase) {
    return new RegExp(searchPhrase, 'gi').test(textContent);
  });

  if (found.length > 0) {
    memo[key] = found;
  }

  return memo;
}, {});

const createSpan = (textNodes, searchPhrase, replacement) => {
  const div = document.createElement('span');
  textNodes.forEach((item, index) => {
    appendTextNode(div, item);
    if (index < textNodes.length - 1) {
      appendStrike(div, searchPhrase, replacement);
    }
  });

  return div;
};

const clearChildren = (parent) => {
  parent.childNodes.forEach(childElement => parent.removeChild(childElement));
}

const appendTextNode = (parent, text) => {
  parent.appendChild(document.createTextNode(text));
}

const appendStrike = (parent, text, replacement) => {
  let strike = document.createElement('strike');
  parent.appendChild(strike);
  appendTextNode(strike, text);
  appendTextNode(parent, ' ' + replacement);
}

textNodes.forEach(function(node) {
  let replaced = false;
  for (replacement in config) {
    config[replacement].forEach(function(searchPhrase) {
      var text = node.nodeValue;
      var foundItems = text.split(searchPhrase);
      if (!replaced && foundItems.length > 1) {
        replaced = true;
        node.parentElement.replaceChild(createSpan(foundItems, searchPhrase, replacement), node);
      }
    });
  };
});



/* ----------- replace images ----------- */

var imgConfig = [
  'Mészáros Lőrinc',
  'Tiborcz István', 
  'Garancsi István',
  'Andy Vajna',
  'Flier János'
];

imgConfig = imgConfig.map(s => s.toLowerCase());

var imgSearchExtra = imgConfig.map(s => ekezetmentesit(s)); //ex.: meszaros lorinc
var imgSearchExtra2 = imgSearchExtra.map(s => s.replace(' ', '_')); //ex.: meszaros_lorinc
var imgSearchExtra3 = imgSearchExtra.map(s => s.replace(' ', '-')); //ex.: meszaros-lorinc

imgConfig = imgConfig.concat(imgSearchExtra, imgSearchExtra2, imgSearchExtra3);

var images = [];

chrome.runtime.onMessage.addListener(
  function(request, sender, sendResponse) {
    var image = images[request.imgId];
    image.src = request.uri;
  }
);


var lastAdded = 0;
addAll();

setInterval(function(){
  if(lastAdded + 1000 < Date.now()){
    addAll();
  }
}, 5000);

document.addEventListener('DOMNodeInserted', waitAndAdd);

function waitAndAdd(){
  setTimeout(function(){
    if(lastAdded + 1000 < Date.now()){
      addAll();
    }
  }, 1000);
}

function addAll(){
  lastAdded = Date.now();
  //console.log(Math.floor(lastAdded/1000) + ' addall ');
  addImages(Array.from( document.querySelectorAll('img:not([data-orbanized])') ));
}

function addImages(toAdd){
  toAdd = toAdd.filter(isMutyi);

  var oldLength = images.length;
  images = images.concat(toAdd);

  for(var i = oldLength; i<oldLength+toAdd.length; i++){
    var img = images[i];
    chrome.runtime.sendMessage({url: img.src, imgId: i});
  }

}


function isMutyi(img){
  if(img.dataset.orbanized !== undefined && img.dataset.orbanized){
    return false;
  }

  img.dataset.orbanized = true;

  if(img.src.endsWith('.gif') || img.src.endsWith('.svg')){
    return false;
  }

  var tmp = img.title.toLowerCase() +
            img.alt.toLowerCase() +
            img.src.toLowerCase() +
            decodeURIComponent(img.src).toLowerCase();

  var a = img;
  while(a){
    if(a.nodeName == 'A'){
      tmp += a.href;
      break;
    }
    a = a.parentNode;
  }

  for(var i = 0; i<imgConfig.length; i++){
    if(tmp.includes(imgConfig[i])){
      return true;
    }
  }

  return false;
}

function ekezetmentesit(srt){
  return srt.replace(/[áéíóöőúüű]/g, function(c){
    var map = {'á': 'a', 'é': 'e', 'í': 'i', 'ó': 'o', 'ö': 'o', 'ő': 'o', 'ú': 'u', 'ü': 'u', 'ű': 'u'};
    return map[c];
  });
}